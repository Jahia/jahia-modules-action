# This workflow performs various tasks for cleanup, triage, ... on an individual GitHub PR
# It should be called based on PR events
# Note: re-usable workflows must be in the .github/workflows folder, amongst other workflows dedicated
# to the jahia-modules-action repository. Thus using "reusable-" prefix to easily identify them.
name: PR Chores

on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read

jobs:
  lint-pr-title:
    name: Lint PR Title
    runs-on: ubuntu-latest
    # It does not make sense to run that workflow when a PR is closed
    if: ${{ github.event.action != 'closed' }}
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        id: lint_pr_title
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}

      # When the previous steps fails, the workflow would stop. By adding this
      # condition you can continue the execution with the populated error message.          
      - uses: marocchino/sticky-pull-request-comment@v2
        if: always() && (steps.lint_pr_title.outputs.error_message != null)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:
          header: pr-title-lint-error
          message: |
            Hey there and thank you for opening this pull request! 👋🏼
            
            We require pull request titles to follow the [Conventional Commits specification](https://www.conventionalcommits.org/en/v1.0.0/) and it looks like your proposed title needs to be adjusted.

            Details:
            
            ```
            ${{ steps.lint_pr_title.outputs.error_message }}
            ```

            Sample valid messages:

            A PR introducing a breaking change(!)
            ```
            feat!: send an email to the customer when a product is shipped
            ```

            A regular commit
            ```
            docs: correct spelling of CHANGELOG
            ```

            _This message will be deleted once the PR title conforms with the convention._

      # Delete a previous comment when the issue has been resolved
      - if: ${{ steps.lint_pr_title.outputs.error_message == null }}
        uses: marocchino/sticky-pull-request-comment@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:   
          header: pr-title-lint-error
          delete: true

  # Check for changelog entries using chachalog
  changelog-validation:
    name: Validate Changelog
    runs-on: ubuntu-latest
    # It does not make sense to run that workflow when a PR is closed
    if: ${{ github.event.action != 'closed' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Check for skip-changelog label
        id: check_skip_label
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const hasSkipLabel = labels.some(label => label.name === 'skip-changelog');
            core.setOutput('skip_changelog', hasSkipLabel);
            return hasSkipLabel;

      - name: Install chachalog
        if: steps.check_skip_label.outputs.skip_changelog != 'true'
        run: npm install -g chachalog

      - name: Check for changelog entries
        id: check_changelog
        if: steps.check_skip_label.outputs.skip_changelog != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}
        run: |
          # Check if there are any changelog entry files (excluding intro.md)
          changelog_files=$(ls .chachalog/*.md 2>/dev/null | grep -v "intro.md" | head -1)
          if [ -n "$changelog_files" ]; then
            echo "changelog_exists=true" >> $GITHUB_OUTPUT
            echo "Changelog entries found"
          else
            echo "changelog_exists=false" >> $GITHUB_OUTPUT
            echo "No changelog entries found"
          fi

      - name: Add changelog comment for missing entry
        if: steps.check_skip_label.outputs.skip_changelog != 'true' && steps.check_changelog.outputs.changelog_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}
        run: |
          chachalog comment-pr

      - name: Remove changelog comment when entry exists
        if: steps.check_skip_label.outputs.skip_changelog != 'true' && steps.check_changelog.outputs.changelog_exists == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}
        run: |
          chachalog delete-pr-comment || true

      - name: Remove changelog comment when skipping
        if: steps.check_skip_label.outputs.skip_changelog == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}
        run: |
          chachalog delete-pr-comment || true

      - name: Fail if changelog required but missing
        if: steps.check_skip_label.outputs.skip_changelog != 'true' && steps.check_changelog.outputs.changelog_exists != 'true'
        run: |
          echo "::error::Changelog entry is required for this PR. Please add a changelog entry or add the 'skip-changelog' label."
          exit 1

  # When closing the PR, label it based on conventional commits
  # https://github.com/marketplace/actions/conventionnal-commit-pr-labeler
  label-release:
    runs-on: ubuntu-latest
    name: Apply label base on conventional commit
    if: ${{ github.event.action == 'closed' }}
    steps:
      - uses: stephdotnet/conventional-commit-pr-labels@0.2.0
        with:
          token: ${{ secrets.GH_ISSUES_PRS_CHORES }}
