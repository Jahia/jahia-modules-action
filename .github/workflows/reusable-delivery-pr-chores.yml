# This workflow performs various tasks for cleanup, triage, ... on an individual GitHub PR
# It should be called based on PR events
# Note: re-usable workflows must be in the .github/workflows folder, amongst other workflows dedicated
# to the jahia-modules-action repository. Thus using "reusable-" prefix to easily identify them.
name: PR Chores

on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read

jobs:
  lint-pr-title:
    name: Lint PR Title
    runs-on: ubuntu-slim
    # It does not make sense to run that workflow when a PR is closed
    if: ${{ github.event.action != 'closed' }}
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        id: lint_pr_title
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}

      # When the previous steps fails, the workflow would stop. By adding this
      # condition you can continue the execution with the populated error message.          
      - uses: marocchino/sticky-pull-request-comment@v2
        if: always() && (steps.lint_pr_title.outputs.error_message != null)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:
          header: pr-title-lint-error
          message: |
            Hey there and thank you for opening this pull request! üëãüèº
            
            We require pull request titles to follow the [Conventional Commits specification](https://www.conventionalcommits.org/en/v1.0.0/) and it looks like your proposed title needs to be adjusted.

            Details:
            
            ```
            ${{ steps.lint_pr_title.outputs.error_message }}
            ```

            Sample valid messages:

            A PR introducing a breaking change(!)
            ```
            feat!: send an email to the customer when a product is shipped
            ```

            A regular commit
            ```
            docs: correct spelling of CHANGELOG
            ```

            _This message will be deleted once the PR title conforms with the convention._

      # Delete a previous comment when the issue has been resolved
      - uses: marocchino/sticky-pull-request-comment@v2
        if: ${{ steps.lint_pr_title.outputs.error_message == null }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:   
          header: pr-title-lint-error
          delete: true

  # Add a comment with documentation guidelines when docs/ folder is modified
  docs-comment:
    runs-on: ubuntu-slim
    name: Post documentation guidelines
    if: ${{ github.event.action != 'closed' }}
    steps:
      - uses: actions/checkout@v4

      # Check if changes took place in the docs/ folder
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            docs:
              - 'docs/**'

      # If changes are present in the docs/ folder, add a comment PR         
      - uses: marocchino/sticky-pull-request-comment@v2
        if: ${{ steps.changes.outputs.docs == 'true'}}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:
          header: doc-instructions
          message: |
            ## üìù Documentation Guidelines
            
            Thank you for contributing to our documentation! To ensure your contributions meet our standards, please review these resources:
            
            - **[How to push markdown documents to the Academy](https://jahia-confluence.atlassian.net/wiki/spaces/PR/pages/634159106/Documentation+in+the+codebases)** - Learn the process for publishing documentation
            - **[Documentation style guide and writing guidelines](https://jahia-confluence.atlassian.net/wiki/spaces/PR/pages/2065360/Documentation+style+guide)** - Follow our style conventions
            
            _This comment is posted automatically when changes are detected in the `docs/` folder._
            

      # Delete a previous comment if there are no changes in docs/
      - uses: marocchino/sticky-pull-request-comment@v2
        if: ${{ steps.changes.outputs.docs == 'false'}}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ISSUES_PRS_CHORES }}        
        with:   
          header: doc-instructions
          delete: true

  # When closing the PR, label it based on conventional commits
  # https://github.com/marketplace/actions/conventionnal-commit-pr-labeler
  label-release:
    runs-on: ubuntu-slim
    name: Apply label base on conventional commit
    if: ${{ github.event.action == 'closed' }}
    steps:
      - uses: stephdotnet/conventional-commit-pr-labels@0.2.0
        with:
          token: ${{ secrets.GH_ISSUES_PRS_CHORES }}
